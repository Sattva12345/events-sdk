<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Short Link Test</title>
</head>
<body>
<script>
// Тест через сервисы укорачивания ссылок
(function() {
    console.log('Testing short link services...');
    
    const params = new URLSearchParams(window.location.search);
    const trackingData = Object.fromEntries(params.entries());
    
    // Формируем полный URL для нашего трекера
    const fullTrackingUrl = new URL('https://affiliate.33rd.pro/api/tracker.php');
    Object.entries(trackingData).forEach(([key, value]) => {
        if (value) fullTrackingUrl.searchParams.append(key, String(value));
    });
    
    console.log('Full tracking URL:', fullTrackingUrl.toString());
    
    // Тестируем разные сервисы коротких ссылок
    const shortLinkServices = [
        // 1. TinyURL
        {
            name: 'TinyURL',
            url: 'https://tinyurl.com/api-create.php?url=' + encodeURIComponent(fullTrackingUrl.toString())
        },
        // 2. is.gd
        {
            name: 'is.gd',
            url: 'https://is.gd/create.php?format=simple&url=' + encodeURIComponent(fullTrackingUrl.toString())
        },
        // 3. v.gd
        {
            name: 'v.gd', 
            url: 'https://v.gd/create.php?format=simple&url=' + encodeURIComponent(fullTrackingUrl.toString())
        }
    ];
    
    // Тестируем создание коротких ссылок
    async function testShortLinks() {
        console.log('Creating short links...');
        
        for (const service of shortLinkServices) {
            try {
                console.log(`Testing ${service.name}...`);
                
                const response = await fetch(service.url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const shortUrl = await response.text();
                    console.log(`✅ ${service.name} created: ${shortUrl}`);
                    
                    // Пробуем отправить данные через короткую ссылку
                    await testShortUrl(service.name, shortUrl.trim());
                } else {
                    console.log(`❌ ${service.name} failed: ${response.status}`);
                }
                
            } catch (e) {
                console.log(`❌ ${service.name} error:`, e.message);
            }
        }
        
        // Тестируем предсозданные короткие ссылки
        await testPredefinedShortLinks();
    }
    
    async function testShortUrl(serviceName, shortUrl) {
        try {
            // Пробуем GET запрос к короткой ссылке
            const img = new Image();
            img.onload = () => console.log(`✅ ${serviceName} tracking successful via image`);
            img.onerror = () => console.log(`❌ ${serviceName} tracking blocked via image`);
            img.src = shortUrl;
            
            // Пробуем fetch
            fetch(shortUrl, { method: 'GET', mode: 'no-cors' })
                .then(() => console.log(`✅ ${serviceName} tracking successful via fetch`))
                .catch(e => console.log(`❌ ${serviceName} tracking blocked via fetch:`, e.message));
                
        } catch (e) {
            console.log(`❌ ${serviceName} tracking error:`, e.message);
        }
    }
    
    // Тестируем заранее созданные короткие ссылки (если у вас есть)
    async function testPredefinedShortLinks() {
        const predefinedLinks = [
            'https://bit.ly/test123',  // Создайте эти ссылки вручную
            'https://tinyurl.com/test456',
            'https://short.link/test789'
        ];
        
        console.log('Testing predefined short links...');
        
        for (const link of predefinedLinks) {
            try {
                console.log(`Testing predefined link: ${link}`);
                
                const img = new Image();
                img.onload = () => console.log(`✅ Predefined link successful: ${link}`);
                img.onerror = () => console.log(`❌ Predefined link blocked: ${link}`);
                img.src = link + '?t=' + Date.now(); // Добавляем timestamp
                
            } catch (e) {
                console.log(`❌ Predefined link error: ${link}`, e.message);
            }
        }
    }
    
    // Запускаем тесты
    testShortLinks();
    
    // Уведомляем родительское окно
    setTimeout(() => {
        if (window.parent) {
            window.parent.postMessage({
                type: 'shortlink_test_complete',
                message: 'Check console for short link test results'
            }, '*');
        }
    }, 5000);
    
})();
</script>
</body>
</html>